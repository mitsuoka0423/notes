---
title: "M5UnitV2ã®æ¤œå‡ºçµæœã‚’Ambientã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒ¢"
emoji: "ğŸ‰"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["M5Stack", "M5UnitV2", "IoT", "Ambient"]
published: true
---

# ã¯ã˜ã‚ã«

M5UnitV2æµè¡Œã£ã¦ã¾ã™ã­ã€‚
ç§ã‚‚æ‰‹ã«å…¥ã‚ŒãŸã®ã§ã€æ¤œå‡ºçµæœã‚’Ambientã«é€ä¿¡ã™ã‚‹ã¾ã§ã®æ‰‹é †ã‚’ãƒ¡ãƒ¢ã—ã¾ã™ã€‚

å®Œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/tmitsuoka0423/m5unitv2-m5stickc-ambient

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

å…ˆé§†è€…ã®è¨˜äº‹ã‚’å‚è€ƒã«é€²ã‚ã¦ã„ãã€‚

https://qiita.com/airpocket/items/e6f736e539e18a314ae2

- ãƒ‰ãƒ©ã‚¤ãƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
  - ãƒ‰ãƒ©ã‚¤ãƒãŒRARãƒ•ã‚¡ã‚¤ãƒ«ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€7-zipã‚’åˆ©ç”¨ã—ã¦è§£å‡
- ãƒ‡ãƒã‚¤ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ > ã»ã‹ã®ãƒ‡ãƒã‚¤ã‚¹ > USB 10/100 LAN ã«ãƒ‰ãƒ©ã‚¤ãƒã‚’è¿½åŠ ã™ã‚‹

ç„¡äº‹èªè­˜ã€‚

[![Image from Gyazo](https://i.gyazo.com/6ce2f69c44597664362fba29226dd43a.png)](https://gyazo.com/6ce2f69c44597664362fba29226dd43a)

# ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®æ©Ÿèƒ½ã§éŠã¶

M5UnitV2ã‚’ãƒ‘ã‚½ã‚³ãƒ³ã«æ¥ç¶šã—ãŸçŠ¶æ…‹ã§ã€http://10.254.239.1/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™ã€‚

[![Image from Gyazo](https://i.gyazo.com/548a06d27eaa2e02365c78ab735675e7.png)](https://gyazo.com/548a06d27eaa2e02365c78ab735675e7)

ã„ã‚ã„ã‚ç”¨æ„ã•ã‚Œã¦ã„ã¦ã€ã“ã‚Œã‚’ä½¿ã£ã¦éŠã¶ã ã‘ã§ã‚‚çµæ§‹æ¥½ã—ã‚ã‚‹ã€‚

# æ¤œå‡ºçµæœã‚’Ambientã«é€ä¿¡ã™ã‚‹

https://qiita.com/airpocket/items/e6f736e539e18a314ae2#8serial%E5%87%BA%E5%8A%9B%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF

ä¸Šè¨˜ã®è¨˜äº‹ã«ã‚ˆã‚‹ã¨ã€

> UnitV2ã®built-in recognition functionã®å†…ã€Camera Streamã¨Audio FFTä»¥å¤–ã®æ©Ÿèƒ½ã¯ã€æ¤œå‡ºçµæœã‚’å•ç­”ç„¡ç”¨ã§ã‚·ãƒªã‚¢ãƒ«å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿groveç«¯å­ã‚’é€šã˜ã¦UARTã§å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€ã“ã‚Œã‚’èª­ã¿å–ã‚Œã°å¤–éƒ¨ã®è£…ç½®ã§æ¤œå‡ºçµæœã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚

ã¨ã®ã“ã¨ãªã®ã§ã€ä¸€æ—¦ã€`UnitV2 --> M5StickC --> Ambient`ã¨ã„ã†çµŒè·¯ã§é€ä¿¡ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

> UnitV2ä¸Šã‹ã‚‰ç›´æ¥curlã¨ã‹ã§Ambientã®APIã‚’å©ãã“ã¨ã‚‚ã§ããã†ã§ã™ãŒã€ãã‚Œã¯åˆ¥é€”èª¿æŸ»ã—ã¾ã™ã€‚

## M5UnitV2ã¨M5StickCã‚’æ¥ç¶šã™ã‚‹

æ‰‹å…ƒã«ã‚ã£ãŸGroveã‚±ãƒ¼ãƒ–ãƒ«ã§æ¥ç¶šã€‚

[![Image from Gyazo](https://i.gyazo.com/bd9f3fd55bc6596a2d6925e397758826.jpg)](https://gyazo.com/bd9f3fd55bc6596a2d6925e397758826)

## UnitV2ã®å‡ºåŠ›ã‚’M5StickCã§èª­ã¿å–ã‚‹

M5StickCã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚

```cpp
#include <M5StickC.h>

void setup() {
  M5.begin();

  Serial.begin(115200);
  Serial2.begin(115200, SERIAL_8N1, 33, 32);
}

void loop(){
  if(Serial2.available()) {
    String receiveString = Serial2.readStringUntil('\n');
    if(receiveString[0] == '{'){
      Serial.println(receiveString);
    }
  }
}
```

Face Detectorã‚’èµ·å‹•ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã®å‡ºåŠ›ã‚’å–å¾—ã§ãã¾ã—ãŸã€‚

[![Image from Gyazo](https://i.gyazo.com/85b70231aa313f334b92355dd7d35f0a.png)](https://gyazo.com/85b70231aa313f334b92355dd7d35f0a)

å½¢ã‚’æ•´ãˆã‚‹ã¨ã“ã‚“ãªå†…å®¹ã€‚

```json
{
  "num": 1,
  "face": [
    {
      "x": 26.47280502,
      "y": 333.1088257,
      "w": 125.7219543,
      "h": 144.8911743,
      "prob": 0.997483611,
      "mark": [
        {
          "x": 42,
          "y": 380
        },
        {
          "x": 86,
          "y": 378
        },
        {
          "x": 48,
          "y": 404
        },
        {
          "x": 52,
          "y": 442
        },
        {
          "x": 84,
          "y": 440
        }
      ]
    }
  ],
  "running": "Face Detector"
}
```

## JSONã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

UnitV2ã®å‡ºåŠ›ãŒJSONãªã®ã§ã€M5StickCä¸Šã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã€å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚

ä»Šå›ã¯ã€`ArduinoJson`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

> [ã€M5StickC Plus/Arduinoã€‘Arduinoã§jsonã‚’æ‰±ã†](https://rikoubou.hatenablog.com/entry/2021/04/16/162258)ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
> ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã¯ã“ã¡ã‚‰ã‚’å‚ç…§ãã ã•ã„ã€‚

```cpp
#include <M5StickC.h>
#include <ArduinoJson.h>

DynamicJsonDocument doc(1024);

void setup()
{
  M5.begin();

  Serial.begin(115200);
  Serial2.begin(115200, SERIAL_8N1, 33, 32);
}

void loop()
{
  if (Serial2.available())
  {
    String receiveString = Serial2.readStringUntil('\n');

    // JSONã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
    deserializeJson(doc, receiveString);

    // ã“ã‚“ãªæ„Ÿã˜ã§ä¸­èº«ã‚’å–ã‚Šå‡ºã›ã‚‹
    double x = doc["face"][0]["x"];
    Serial.println(x);
  }
}
```

## Ambientã«é€ä¿¡ã™ã‚‹

å…ˆç¨‹ã®ã‚³ãƒ¼ãƒ‰ã«Ambientã¸ã®é€ä¿¡å‡¦ç†ã‚’è¿½åŠ ã—ã¦å®Œæˆã§ã™ã€‚

`Ambient`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ã€ä»¥ä¸‹ã®æ‰‹é †ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
https://ambidata.io/docs/esp8266/#library_import

```cpp
#include <M5StickC.h>
#include <ArduinoJson.h>
#include <Ambient.h>
#include <WiFi.h>

WiFiClient client;
const char *ssid = "SSID";
const char *password = "PASSWORD";

Ambient ambient;
unsigned int channelId = 10000; // CHANNEL ID
const char *writeKey = "WRITE KEY";

int lastSendTime = 0;

DynamicJsonDocument doc(1024);

void setup()
{
  M5.begin();

  Serial.begin(115200);
  Serial2.begin(115200, SERIAL_8N1, 33, 32);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {}
}

void loop()
{
  if (Serial2.available())
  {
    String receiveString = Serial2.readStringUntil('\n');

    // JSONã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
    deserializeJson(doc, receiveString);

    // ã“ã‚“ãªæ„Ÿã˜ã§ä¸­èº«ã‚’å–ã‚Šå‡ºã›ã‚‹
    double x = doc["face"][0]["x"];
    Serial.println(x);

    // ä¸€å®šé–“éš”ã§Ambientã«é€ä¿¡
    if (millis() - lastSendTime > 60000)
    {
      ambient.begin(channelId, writeKey, &client);
      ambient.set(1, x);
      ambient.send();

      lastSendTime = millis();
    }
  }
}
```

# ã¾ã¨ã‚

M5UnitV2ã®æ¤œå‡ºçµæœã‚’M5StickCã‹ã‚‰Ambientã«é€ä¿¡ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ã‚’çŸ¥ã£ã¦ã‚‹æ–¹ã¯æ•™ãˆã¦ä¸‹ã•ã„ï½ã€‚
